
const translations = {
  es: {
    'hero.badge': 'Mensajes premium',
    'hero.title': 'Lo digo por ti',
    'hero.subtitle': 'Genera mensajes listos para enviar en segundos con un tono impecable y humano.',
    'form.situationLabel': 'Busca una situación',
    'form.situationPlaceholder': 'Ej: Recordar un pago pendiente',
    'form.descriptionLabel': 'Describe tu situación',
    'form.descriptionPlaceholder': 'Describe tu situación con detalle para que podamos ayudarte a decirlo mejor.',
    'form.toneLabel': 'Tono',
    'form.toneFormal': 'Formal',
    'form.toneClose': 'Cercano',
    'form.toneFun': 'Divertido',
    'form.intensityLabel': 'Intensidad',
    'form.intensity1': '1 Suave',
    'form.intensity2': '2 Normal',
    'form.intensity3': '3 Directo',
    'form.intensity4': '4 Muy directo',
    'form.generateBtn': 'Generar mensaje',
    'form.humanized': 'Texto optimizado para sonar natural y humano.',
    'form.firmnessLabel': 'Firmeza',
    'form.firmnessSoft': 'Suave',
    'form.firmnessNormal': 'Normal',
    'form.firmnessDirect': 'Directo',
    'form.humanizeLabel': 'Humanizar',
    'form.humanizeHelp': 'Activa un estilo mas natural, calido y cercano.',
    'form.targetWordsLabel': 'Longitud objetivo',
    'form.targetWordsHint': 'Palabras',
    'form.targetWordsPlaceholder': 'Ej: 80',
    'form.wordCountLabel': 'Recuento de palabras',
    'form.wordCount.singular': 'palabra',
    'form.wordCount.plural': 'palabras',
    'results.eyebrow': 'Resultados',
    'results.title': 'Opciones listas para copiar',
    'results.empty': 'Escribe la situación y pulsa "Generar mensaje".',
    'results.error': 'No hemos podido generar un mensaje. Usa estas opciones listas.',
    'examples.eyebrow': 'Ejemplos',
    'examples.title': 'Cargar un ejemplo para empezar',
    'examples.useBtn': 'Usar este ejemplo',
    'examples.category.trabajo': 'Trabajo',
    'examples.category.pareja': 'Pareja',
    'examples.category.familia_amigos': 'Familia / Amigos',
    'examples.category.dinero': 'Dinero',
    'examples.category.jefe': 'Jefe',
    'examples.category.cliente': 'Cliente / Empresa',
    'examples.category.estudio': 'Estudio',
    'examples.category.formal': 'Formal',
    'examples.category.urgente': 'Urgente',
    'examples.category.personalizado': 'Personalizado',
    'examples.category.general': 'General',
    'favorites.eyebrow': 'Favoritos',
    'favorites.title': 'Tus mensajes guardados',
    'favorites.empty': 'Aún no has guardado favoritos.',
    'buttons.copy': 'Copiar',
    'buttons.copied': 'Copiado',
    'buttons.saveFavorite': 'Guardar favorito',
    'buttons.favorited': 'Favorito',
    'buttons.useExample': 'Usar este ejemplo',
    'status.loading': 'Generando mensajes...',
    'status.ready': 'Opciones listas',
    'intensity.value.1': 'Suave',
    'intensity.value.2': 'Normal',
    'intensity.value.3': 'Directo',
    'intensity.value.4': 'Muy directo'
  },
  en: {
    'hero.badge': 'Premium messages',
    'hero.title': 'Lo digo por ti',
    'hero.subtitle': 'Generate ready-to-send messages in seconds with a natural, human tone.',
    'form.situationLabel': 'Find a situation',
    'form.situationPlaceholder': 'e.g., Remind about a pending payment',
    'form.descriptionLabel': 'Describe your situation',
    'form.descriptionPlaceholder': 'e.g., I lent money to a friend two months ago and want to remind them politely...',
    'form.toneLabel': 'Tone',
    'form.toneFormal': 'Formal',
    'form.toneClose': 'Friendly',
    'form.toneFun': 'Playful',
    'form.intensityLabel': 'Intensity',
    'form.intensity1': '1 Soft',
    'form.intensity2': '2 Normal',
    'form.intensity3': '3 Direct',
    'form.intensity4': '4 Very direct',
    'form.generateBtn': 'Generate message',
    'form.humanized': 'Text optimized to sound natural and human-like.',
    'form.firmnessLabel': 'Firmness',
    'form.firmnessSoft': 'Soft',
    'form.firmnessNormal': 'Normal',
    'form.firmnessDirect': 'Direct',
    'form.humanizeLabel': 'Humanize',
    'form.humanizeHelp': 'Make the tone warmer and more natural when enabled.',
    'form.targetWordsLabel': 'Target length',
    'form.targetWordsHint': 'Words',
    'form.targetWordsPlaceholder': 'e.g., 120',
    'form.wordCount.singular': 'word',
    'form.wordCount.plural': 'words',
    'results.eyebrow': 'Results',
    'results.title': 'Ready-to-copy options',
    'results.empty': 'Describe the situation and tap "Generate message".',
    'results.error': 'We could not generate a message. Try these ready options.',
    'examples.eyebrow': 'Examples',
    'examples.title': 'Load an example to start',
    'examples.useBtn': 'Use this example',
    'examples.category.trabajo': 'Work',
    'examples.category.pareja': 'Relationship',
    'examples.category.familia_amigos': 'Family/Friends',
    'examples.category.dinero': 'Money',
    'examples.category.jefe': 'Manager',
    'examples.category.cliente': 'Client/Company',
    'examples.category.estudio': 'Study',
    'examples.category.formal': 'Formal',
    'examples.category.urgente': 'Urgent',
    'examples.category.personalizado': 'Custom',
    'examples.category.general': 'General',
    'favorites.eyebrow': 'Favorites',
    'favorites.title': 'Saved messages',
    'favorites.empty': 'You have no favorites yet.',
    'buttons.copy': 'Copy',
    'buttons.copied': 'Copied',
    'buttons.saveFavorite': 'Save favorite',
    'buttons.favorited': 'Favorite',
    'buttons.useExample': 'Use this example',
    'status.loading': 'Generating messages...',
    'status.ready': 'Options ready',
    'intensity.value.1': 'Soft',
    'intensity.value.2': 'Normal',
    'intensity.value.3': 'Direct',
    'intensity.value.4': 'Very direct'
  },
  fr: {
    'hero.badge': 'Messages premium',
    'hero.title': 'Lo digo por ti',
    'hero.subtitle': 'Générez des messages prêts à envoyer en quelques secondes, avec un ton naturel et humain.',
    'form.situationLabel': 'Trouver une situation',
    'form.situationPlaceholder': 'Ex : Rappeler un paiement en attente',
    'form.descriptionLabel': 'Décris ta situation',
    'form.descriptionPlaceholder': 'Ex : J’ai prêté de l’argent à un ami il y a deux mois et je veux le lui rappeler sans être brusque...',
    'form.toneLabel': 'Ton',
    'form.toneFormal': 'Formel',
    'form.toneClose': 'Proche',
    'form.toneFun': 'Ludique',
    'form.intensityLabel': 'Intensite',
    'form.intensity1': '1 Doux',
    'form.intensity2': '2 Équilibré',
    'form.intensity3': '3 Direct',
    'form.intensity4': '4 Très direct',
    'form.generateBtn': 'Générer',
    'form.humanized': 'Texte optimisé pour paraître naturel et humain.',
    'form.firmnessLabel': 'Intensite',
    'form.firmnessSoft': 'Doux',
    'form.firmnessNormal': 'Équilibré',
    'form.firmnessDirect': 'Direct',
    'form.humanizeLabel': 'Humaniser',
    'form.humanizeHelp': 'Active un style plus naturel, chaleureux et humain.',
    'form.targetWordsLabel': 'Longueur cible',
    'form.targetWordsHint': 'Mots',
    'form.targetWordsPlaceholder': 'Ex : 120',
    'form.wordCount.singular': 'mot',
    'form.wordCount.plural': 'mots',
    'results.eyebrow': 'Résultats',
    'results.title': 'Options prêtes à copier',
    'results.empty': 'Décris la situation puis clique sur "Générer".',
    'results.error': 'Impossible de générer un message. Voici des options prêtes.',
    'examples.eyebrow': 'Exemples',
    'examples.title': 'Charger un exemple pour commencer',
    'examples.useBtn': 'Utiliser cet exemple',
    'examples.category.trabajo': 'Travail',
    'examples.category.pareja': 'Couple',
    'examples.category.familia_amigos': 'Famille/Amis',
    'examples.category.dinero': 'Argent',
    'examples.category.jefe': 'Supérieur',
    'examples.category.cliente': 'Client/Entreprise',
    'examples.category.estudio': 'Études',
    'examples.category.formal': 'Formel',
    'examples.category.urgente': 'Urgent',
    'examples.category.personalizado': 'Personnalisé',
    'examples.category.general': 'Général',
    'favorites.eyebrow': 'Favoris',
    'favorites.title': 'Messages enregistrés',
    'favorites.empty': 'Aucun favori pour le moment.',
    'buttons.copy': 'Copier',
    'buttons.copied': 'Copié',
    'buttons.saveFavorite': 'Enregistrer',
    'buttons.favorited': 'Favori',
    'buttons.useExample': 'Utiliser cet exemple',
    'status.loading': 'Generation des messages...',
    'status.ready': 'Options prêtes',
    'intensity.value.1': 'Doux',
    'intensity.value.2': 'Équilibré',
    'intensity.value.3': 'Direct',
    'intensity.value.4': 'Très direct'
  },
  de: {
    'hero.badge': 'Premium-Nachrichten',
    'hero.title': 'Lo digo por ti',
    'hero.subtitle': 'Erstelle in Sekunden versandfertige Nachrichten mit natürlichem, menschlichem Ton.',
    'form.situationLabel': 'Situation finden',
    'form.situationPlaceholder': 'z. B. An eine offene Zahlung erinnern',
    'form.descriptionLabel': 'Beschreibe deine Situation',
    'form.descriptionPlaceholder': 'z. B. Ich habe einem Freund Geld geliehen und möchte ihn höflich erinnern...',
    'form.toneLabel': 'Ton',
    'form.toneFormal': 'Formell',
    'form.toneClose': 'Nahbar',
    'form.toneFun': 'Locker',
    'form.targetWordsLabel': 'Zielumfang',
    'form.targetWordsHint': 'Woerter',
    'form.targetWordsPlaceholder': 'z. B. 120',
    'form.intensityLabel': 'Intensitaet',
    'form.intensity1': '1 Sanft',
    'form.intensity2': '2 Normal',
    'form.intensity3': '3 Direkt',
    'form.intensity4': '4 Sehr direkt',
    'form.generateBtn': 'Nachricht erstellen',
    'form.humanized': 'Text optimiert, um natürlich und menschlich zu klingen.',
    'form.firmnessLabel': 'Bestimmtheit',
    'form.firmnessSoft': 'Sanft',
    'form.firmnessNormal': 'Ausgewogen',
    'form.firmnessDirect': 'Direkt',
    'form.humanizeLabel': 'Natürlich',
    'form.humanizeHelp': 'Aktiviere einen wärmeren, natürlicheren Stil.',
    'form.wordCount.singular': 'Wort',
    'form.wordCount.plural': 'Wörter',
    'results.eyebrow': 'Ergebnisse',
    'results.title': 'Sofort kopierbare Optionen',
    'results.empty': 'Beschreibe die Situation und klicke „Nachricht erstellen“.',
    'results.error': 'Nachricht konnte nicht erstellt werden. Nutze diese Optionen.',
    'examples.eyebrow': 'Beispiele',
    'examples.title': 'Ein Beispiel zum Start wählen',
    'examples.useBtn': 'Beispiel nutzen',
    'examples.category.trabajo': 'Arbeit',
    'examples.category.pareja': 'Beziehung',
    'examples.category.familia_amigos': 'Familie/Freunde',
    'examples.category.dinero': 'Finanzen',
    'examples.category.jefe': 'Vorgesetzter',
    'examples.category.cliente': 'Kunde/Firma',
    'examples.category.estudio': 'Studium',
    'examples.category.formal': 'Formell',
    'examples.category.urgente': 'Dringend',
    'examples.category.personalizado': 'Individuell',
    'examples.category.general': 'Allgemein',
    'favorites.eyebrow': 'Favoriten',
    'favorites.title': 'Gespeicherte Nachrichten',
    'favorites.empty': 'Noch keine Favoriten.',
    'buttons.copy': 'Kopieren',
    'buttons.copied': 'Kopiert',
    'buttons.saveFavorite': 'Favorit speichern',
    'buttons.favorited': 'Favorit',
    'buttons.useExample': 'Beispiel nutzen',
    'status.loading': 'Nachrichten werden generiert...',
    'status.ready': 'Optionen bereit',
    'intensity.value.1': 'Sanft',
    'intensity.value.2': 'Normal',
    'intensity.value.3': 'Direkt',
    'intensity.value.4': 'Sehr direkt'
  },
  it: {
    'hero.badge': 'Messaggi premium',
    'hero.title': 'Lo digo por ti',
    'hero.subtitle': 'Genera messaggi pronti all’uso in pochi secondi con un tono naturale e umano.',
    'form.situationLabel': 'Cerca una situazione',
    'form.situationPlaceholder': 'Es: Ricordare un pagamento in sospeso',
    'form.descriptionLabel': 'Descrivi la situazione',
    'form.descriptionPlaceholder': 'Es: Ho prestato soldi a un amico e voglio ricordarglielo con tatto...',
    'form.toneLabel': 'Tono',
    'form.toneFormal': 'Formale',
    'form.toneClose': 'Vicino',
    'form.toneFun': 'Divertente',
    'form.targetWordsLabel': 'Lunghezza obiettivo',
    'form.targetWordsHint': 'Parole',
    'form.targetWordsPlaceholder': 'Es: 120',
    'form.intensityLabel': 'Intensita',
    'form.intensity1': '1 Leggero',
    'form.intensity2': '2 Normale',
    'form.intensity3': '3 Diretto',
    'form.intensity4': '4 Molto diretto',
    'form.generateBtn': 'Genera messaggio',
    'form.humanized': 'Testo ottimizzato per sembrare naturale e umano.',
    'form.firmnessLabel': 'Firmezza',
    'form.firmnessSoft': 'Leggero',
    'form.firmnessNormal': 'Normale',
    'form.firmnessDirect': 'Diretto',
    'form.humanizeLabel': 'Umanizzare',
    'form.humanizeHelp': 'Attiva uno stile più naturale, caldo e umano.',
    'form.wordCount.singular': 'parola',
    'form.wordCount.plural': 'parole',
    'results.eyebrow': 'Risultati',
    'results.title': 'Opzioni pronte da copiare',
    'results.empty': 'Descrivi la situazione e premi "Genera messaggio".',
    'results.error': 'Non siamo riusciti a generare il messaggio. Usa queste opzioni.',
    'examples.eyebrow': 'Esempi',
    'examples.title': 'Carica un esempio per iniziare',
    'examples.useBtn': 'Usa questo esempio',
    'examples.category.trabajo': 'Lavoro',
    'examples.category.pareja': 'Coppia',
    'examples.category.familia_amigos': 'Famiglia/Amici',
    'examples.category.dinero': 'Denaro',
    'examples.category.jefe': 'Capo',
    'examples.category.cliente': 'Cliente/Azienda',
    'examples.category.estudio': 'Studio',
    'examples.category.formal': 'Formale',
    'examples.category.urgente': 'Urgente',
    'examples.category.personalizado': 'Personalizzato',
    'examples.category.general': 'Generale',
    'favorites.eyebrow': 'Preferiti',
    'favorites.title': 'I tuoi messaggi salvati',
    'favorites.empty': 'Non hai ancora preferiti.',
    'buttons.copy': 'Copia',
    'buttons.copied': 'Copiato',
    'buttons.saveFavorite': 'Salva nei preferiti',
    'buttons.favorited': 'Preferito',
    'buttons.useExample': 'Usa questo esempio',
    'status.loading': 'Generazione dei messaggi...',
    'status.ready': 'Opzioni pronte',
    'intensity.value.1': 'Leggero',
    'intensity.value.2': 'Normale',
    'intensity.value.3': 'Diretto',
    'intensity.value.4': 'Molto diretto'
  },
  pt: {
    'hero.badge': 'Mensagens premium',
    'hero.title': 'Lo digo por ti',
    'hero.subtitle': 'Gere mensagens prontas para enviar em segundos, com tom natural e humano.',
    'form.situationLabel': 'Busque uma situação',
    'form.situationPlaceholder': 'Ex.: Lembrar um pagamento pendente',
    'form.descriptionLabel': 'Descreva a situação',
    'form.descriptionPlaceholder': 'Ex.: Emprestei dinheiro a um amigo e quero lembrar sem parecer rude...',
    'form.toneLabel': 'Tom',
    'form.toneFormal': 'Formal',
    'form.toneClose': 'Próximo',
    'form.toneFun': 'Divertido',
    'form.intensityLabel': 'Intensidad',
    'form.intensity1': '1 Suave',
    'form.intensity2': '2 Normal',
    'form.intensity3': '3 Direto',
    'form.intensity4': '4 Bem direto',
    'form.generateBtn': 'Gerar mensagem',
    'form.humanized': 'Texto otimizado para soar natural e humano.',
    'form.firmnessLabel': 'Firmeza',
    'form.firmnessSoft': 'Suave',
    'form.firmnessNormal': 'Normal',
    'form.firmnessDirect': 'Direto',
    'form.humanizeLabel': 'Humanizar',
    'form.humanizeHelp': 'Deixa o tom mais natural e próximo quando ativado.',
    'form.wordCount.singular': 'palavra',
    'form.wordCount.plural': 'palavras',
    'results.eyebrow': 'Resultados',
    'results.title': 'Opções prontas para copiar',
    'results.empty': 'Descreva a situação e clique em "Gerar".',
    'results.error': 'Não foi possível gerar. Use estas opções prontas.',
    'examples.eyebrow': 'Exemplos',
    'examples.title': 'Carregue um exemplo para começar',
    'examples.useBtn': 'Usar este exemplo',
    'examples.category.trabajo': 'Trabalho',
    'examples.category.pareja': 'Relacionamento',
    'examples.category.familia_amigos': 'Família/Amigos',
    'examples.category.dinero': 'Dinheiro',
    'examples.category.jefe': 'Chefe',
    'examples.category.cliente': 'Cliente/Empresa',
    'examples.category.estudio': 'Estudos',
    'examples.category.formal': 'Formal',
    'examples.category.urgente': 'Urgente',
    'examples.category.personalizado': 'Personalizado',
    'examples.category.general': 'Geral',
    'favorites.eyebrow': 'Favoritos',
    'favorites.title': 'Mensagens salvas',
    'favorites.empty': 'Você ainda não tem favoritos.',
    'buttons.copy': 'Copiar',
    'buttons.copied': 'Copiado',
    'buttons.saveFavorite': 'Salvar favorito',
    'buttons.favorited': 'Favorito',
    'buttons.useExample': 'Usar este exemplo',
    'status.loading': 'Gerando mensagens...',
    'status.ready': 'Opções prontas',
    'intensity.value.1': 'Suave',
    'intensity.value.2': 'Normal',
    'intensity.value.3': 'Direto',
    'intensity.value.4': 'Bem direto'
  }
};

const targetWordsTranslations = {
  es: {
    'form.targetWordsLabel': 'Longitud objetivo',
    'form.targetWordsHint': 'Palabras',
    'form.targetWordsPlaceholder': 'Ej: 80',
    'form.wordCountLabel': 'Recuento de palabras'
  },
  en: {
    'form.targetWordsLabel': 'Target length',
    'form.targetWordsHint': 'Words',
    'form.targetWordsPlaceholder': 'e.g., 80',
    'form.wordCountLabel': 'Word count'
  },
  fr: {
    'form.targetWordsLabel': 'Longueur cible',
    'form.targetWordsHint': 'Mots',
    'form.targetWordsPlaceholder': 'Ex : 80',
    'form.wordCountLabel': 'Compte de mots'
  },
  de: {
    'form.targetWordsLabel': 'Zielumfang',
    'form.targetWordsHint': 'Woerter',
    'form.targetWordsPlaceholder': 'z. B. 80',
    'form.wordCountLabel': 'Wortzahl'
  },
  it: {
    'form.targetWordsLabel': 'Lunghezza obiettivo',
    'form.targetWordsHint': 'Parole',
    'form.targetWordsPlaceholder': 'Es: 80',
    'form.wordCountLabel': 'Conteggio parole'
  },
  pt: {
    'form.targetWordsLabel': 'Comprimento alvo',
    'form.targetWordsHint': 'Palavras',
    'form.targetWordsPlaceholder': 'Ex.: 80',
    'form.wordCountLabel': 'Contagem de palavras'
  }
};

Object.entries(targetWordsTranslations).forEach(([lang, entries]) => {
  translations[lang] = { ...(translations[lang] || {}), ...entries };
});

const exampleLanguages = ['es', 'en', 'fr', 'de', 'it', 'pt'];

const baseExamples = [
  {
    id: 'factura-cliente',
    category: 'cliente',
    title: 'Recordar una factura pendiente con tacto',
    quick: 'Recordatorio de factura',
    details: 'Recordar a un cliente que la factura vence esta semana sin sonar insistente.',
    tone: 'formal',
    intensity: 2
  },
  {
    id: 'feedback-jefe',
    category: 'jefe',
    title: 'Pedir feedback tras un proyecto',
    quick: 'Pedir feedback al jefe',
    details: 'Solicitar comentarios sobre mi trabajo reciente para seguir mejorando.',
    tone: 'formal',
    intensity: 2
  },
  {
    id: 'disculpa-pareja',
    category: 'pareja',
    title: 'Disculpa por un malentendido',
    quick: 'Disculpa sincera',
    details: 'Quiero disculparme por haber contestado seco anoche y proponer hablarlo con calma.',
    tone: 'cercano',
    intensity: 2
  },
  {
    id: 'dinero-amigo',
    category: 'dinero',
    title: 'Hablar de un dinero prestado',
    quick: 'Recordar un dinero prestado',
    details: 'Recordar a un amigo que aún me debe dinero sin tensar la relación.',
    tone: 'cercano',
    intensity: 2
  },
  {
    id: 'limites-familia',
    category: 'familia_amigos',
    title: 'Poner límites con cariño',
    quick: 'Poner límites a familia',
    details: 'Explicar que necesito tiempo para mí sin que suene a rechazo.',
    tone: 'cercano',
    intensity: 1
  },
  {
    id: 'reclamo-servicio',
    category: 'cliente',
    title: 'Reclamar un servicio con calma',
    quick: 'Reclamo sereno a empresa',
    details: 'Plantear un reclamo por un cargo erróneo manteniendo un tono cordial.',
    tone: 'formal',
    intensity: 3
  },
  {
    id: 'prorroga-estudio',
    category: 'estudio',
    title: 'Pedir prórroga a un profesor',
    quick: 'Pedir prórroga',
    details: 'Solicitar un par de días extra para entregar un trabajo por un imprevisto.',
    tone: 'formal',
    intensity: 2
  },
  {
    id: 'prioridades-jefe',
    category: 'jefe',
    title: 'Aclarar prioridades con el jefe',
    quick: 'Ajustar prioridades',
    details: 'Pedir a mi jefe que confirme qué tareas son prioritarias para enfocarme mejor.',
    tone: 'formal',
    intensity: 2
  },
  {
    id: 'apoyo-pareja',
    category: 'pareja',
    title: 'Ofrecer apoyo en momento difícil',
    quick: 'Mensaje de apoyo',
    details: 'Enviar a mi pareja un mensaje de apoyo porque está pasando una semana complicada.',
    tone: 'cercano',
    intensity: 1
  },
  {
    id: 'plan-amigos',
    category: 'familia_amigos',
    title: 'Cancelar un plan con respeto',
    quick: 'Cancelar plan con amigos',
    details: 'Cancelar un plan y proponer una nueva fecha sin quedar mal.',
    tone: 'cercano',
    intensity: 2
  },
  {
    id: 'cobro-freelance',
    category: 'trabajo',
    title: 'Cobro pendiente de un proyecto',
    quick: 'Cobro pendiente',
    details: 'Pedir el pago de un proyecto freelance con profesionalismo y empatía.',
    tone: 'formal',
    intensity: 3
  },
  {
    id: 'seguimiento-cliente',
    category: 'cliente',
    title: 'Seguimiento amable de propuesta',
    quick: 'Seguimiento de propuesta',
    details: 'Dar seguimiento a una propuesta enviada sin presionar.',
    tone: 'formal',
    intensity: 2
  }
];

const examples = exampleLanguages.flatMap((lang) =>
  baseExamples.map((ex) => ({
    ...ex,
    id: `${lang}-${ex.id}`,
    language: lang
  }))
);

const MAX_MESSAGES = 3;
const TARGET_WORDS_DEFAULT = 100;
const TARGET_WORDS_MIN = 20;
const TARGET_WORDS_MAX = 400;
const FAVORITES_KEY = 'ldpt_favorites';
const HISTORY_KEY = 'ldpt_history';

const situationInput = document.getElementById('situationInput');
const situationTextarea = document.getElementById('situationTextarea');
const toneSelect = document.getElementById('toneSelect');
const intensityRange = document.getElementById('intensityRange');
const intensityValue = document.getElementById('intensityValue');
const languageSelect = document.getElementById('languageSelect');
const generateBtn = document.getElementById('generateBtn');
const resultsContainer = document.getElementById('results');
const examplesContainer = document.getElementById('examples');
const favoritesContainer = document.getElementById('favorites');
const cookieBanner = document.getElementById('cookieBanner');
const cookieAcceptBtn = document.getElementById('cookieAcceptBtn');
const humanizeToggle = document.getElementById('humanizeToggle');
const targetWordsInput = document.getElementById('targetWordsInput');
const wordCounter = document.getElementById('situation-word-counter');
const COOKIE_CONSENT_KEY = 'cookie_consent_accepted';

const state = {
  favorites: [],
  history: [],
  lastMessages: [],
  currentLanguage: (languageSelect && languageSelect.value) || 'es',
  humanize: false,
  wordCount: 0,
  targetWords: TARGET_WORDS_DEFAULT
};

const getDict = (lang) => ({ ...translations.es, ...(translations[lang] || {}) });

const shuffle = (arr) => {
  const cloned = [...arr];
  for (let i = cloned.length - 1; i > 0; i -= 1) {
    const j = Math.floor(Math.random() * (i + 1));
    [cloned[i], cloned[j]] = [cloned[j], cloned[i]];
  }
  return cloned;
};

const updateIntensityLabel = () => {
  const dict = getDict(state.currentLanguage);
  const val = intensityRange.value;
  intensityValue.textContent = dict[`intensity.value.${val}`] || val;
};

const formatWordCount = (count) => {
  const dict = getDict(state.currentLanguage);
  const singular = dict['form.wordCount.singular'] || 'palabra';
  const plural = dict['form.wordCount.plural'] || 'palabras';
  const noun = count === 1 ? singular : plural;
  return `${count} ${noun}`;
};

const updateWordCount = () => {
  if (!wordCounter || !situationTextarea) return;
  const text = (situationTextarea.value || '').trim();
  const words = text ? text.split(/\s+/).filter(Boolean) : [];
  const count = words.length;
  state.wordCount = count;
  wordCounter.textContent = formatWordCount(count);
};

const initializeTargetWordsInput = () => {
  if (!targetWordsInput) return;
  const initialValue = targetWordsInput.value;
  const initial = clampTargetWords(initialValue === '' ? undefined : initialValue);
  if (initialValue === '') {
    state.targetWords = TARGET_WORDS_DEFAULT;
  } else {
    targetWordsInput.value = initial;
    state.targetWords = initial;
  }

  const syncValue = () => {
    if (targetWordsInput.value === '') {
      state.targetWords = TARGET_WORDS_DEFAULT;
      return;
    }
    const sanitized = clampTargetWords(targetWordsInput.value);
    targetWordsInput.value = sanitized;
    state.targetWords = sanitized;
  };

  targetWordsInput.addEventListener('change', syncValue);
  targetWordsInput.addEventListener('blur', syncValue);
  targetWordsInput.addEventListener('input', () => {
    state.targetWords = targetWordsInput.value === '' ? TARGET_WORDS_DEFAULT : clampTargetWords(targetWordsInput.value);
  });
};

const mapFirmnessFromSlider = (value) => {
  const level = Number(value);
  if (level === 1) return 'soft';
  if (level === 2) return 'normal';
  if (level === 3) return 'direct';
  if (level === 4) return 'very_direct';
  return 'normal';
};

const clampTargetWords = (value) => {
  if (value === '' || value === null || value === undefined) return TARGET_WORDS_DEFAULT;
  const num = Number(value);
  if (!Number.isFinite(num)) return TARGET_WORDS_DEFAULT;
  return Math.min(TARGET_WORDS_MAX, Math.max(TARGET_WORDS_MIN, Math.round(num)));
};

const getTargetWordsValue = () => {
  const raw = targetWordsInput ? targetWordsInput.value : '';
  const validated = clampTargetWords(raw);
  state.targetWords = validated;
  return validated;
};

const applyLanguage = (lang) => {
  state.currentLanguage = lang;
  const dict = getDict(lang);
  document.documentElement.setAttribute('lang', lang);
  if (languageSelect) languageSelect.value = lang;

  document.querySelectorAll('[data-i18n]').forEach((el) => {
    const key = el.getAttribute('data-i18n');
    if (dict[key]) {
      el.textContent = dict[key];
    }
  });

  document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (dict[key]) {
      el.setAttribute('placeholder', dict[key]);
    }
  });

  updateIntensityLabel();
  updateWordCount();
  renderExamples();
  renderMessages(state.lastMessages);
  renderFavorites();
};

const loadFavorites = () => {
  try {
    const stored = localStorage.getItem(FAVORITES_KEY);
    state.favorites = stored ? JSON.parse(stored) : [];
  } catch (e) {
    state.favorites = [];
  }
};

const saveFavorites = () => {
  localStorage.setItem(FAVORITES_KEY, JSON.stringify(state.favorites.slice(0, 200)));
};

const loadHistory = () => {
  try {
    const stored = localStorage.getItem(HISTORY_KEY);
    state.history = stored ? JSON.parse(stored) : [];
  } catch (e) {
    state.history = [];
  }
};

const saveHistory = () => {
  localStorage.setItem(HISTORY_KEY, JSON.stringify(state.history.slice(-20)));
};

const copyText = async (text, btn) => {
  try {
    await navigator.clipboard.writeText(text);
    const dict = getDict(state.currentLanguage);
    const original = btn.textContent;
    btn.textContent = dict['buttons.copied'];
    setTimeout(() => {
      btn.textContent = original;
    }, 1200);
  } catch (err) {
    console.error('Copy failed', err);
  }
};

const createTag = (categoryKey, dict) => {
  const tag = document.createElement('span');
  tag.className = 'tag';
  tag.textContent = dict[`examples.category.${categoryKey}`] || categoryKey;
  return tag;
};

const normalizeMessages = (messages) => {
  if (!Array.isArray(messages)) return [];
  return messages
    .map((item) => {
      if (typeof item === 'string') {
        return { text: item, category: 'personalizado' };
      }
      const text = item.text || item.message || '';
      return {
        text,
        category: item.category || 'personalizado'
      };
    })
    .filter((m) => m.text?.trim());
};

const typeText = (element, fullText) => {
  const words = (fullText || '').split(/\s+/).filter(Boolean);
  if (!words.length) {
    element.textContent = fullText || '';
    return;
  }

  const chunkSize = words.length > 120 ? 4 : words.length > 60 ? 3 : words.length > 30 ? 2 : 1;
  const intervalMs = words.length > 120 ? 14 : words.length > 60 ? 18 : 24;
  let index = 0;
  let current = '';

  const interval = setInterval(() => {
    const slice = words.slice(index, index + chunkSize);
    index += chunkSize;
    current = current ? `${current} ${slice.join(' ')}` : slice.join(' ');
    element.textContent = current;

    if (index >= words.length) {
      clearInterval(interval);
      element.textContent = fullText;
    }
  }, intervalMs);
};

const renderMessages = (messages, animateTyping = false) => {
  const dict = getDict(state.currentLanguage);
  const normalized = normalizeMessages(messages);
  state.lastMessages = normalized;
  resultsContainer.innerHTML = '';

  if (!normalized.length) {
    const p = document.createElement('p');
    p.className = 'muted';
    p.textContent = dict['results.empty'];
    resultsContainer.appendChild(p);
    return;
  }

  normalized.forEach((item) => {
    const card = document.createElement('div');
    card.className = 'result-card';

    const tag = createTag(item.category || 'personalizado', dict);
    card.appendChild(tag);

    const text = document.createElement('p');
    if (animateTyping) {
      typeText(text, item.text || '');
    } else {
      text.textContent = item.text;
    }
    card.appendChild(text);

    const wordCount = document.createElement('div');
    wordCount.className = 'result-word-count';
    wordCount.textContent = formatWordCount(item.text.trim().split(/\s+/).filter(Boolean).length);
    card.appendChild(wordCount);

    const actions = document.createElement('div');
    actions.className = 'result-actions';

    const copyBtn = document.createElement('button');
    copyBtn.className = 'btn copy-btn';
    copyBtn.textContent = dict['buttons.copy'];
    copyBtn.type = 'button';
    copyBtn.addEventListener('click', () => copyText(item.text, copyBtn));
    actions.appendChild(copyBtn);

    const favoriteBtn = document.createElement('button');
    favoriteBtn.className = 'btn favorite-btn';
    favoriteBtn.type = 'button';
    const isFav = state.favorites.some((fav) => fav.text === item.text);
    favoriteBtn.classList.toggle('active', isFav);
    favoriteBtn.textContent = isFav ? dict['buttons.favorited'] : dict['buttons.saveFavorite'];
    favoriteBtn.addEventListener('click', () => {
      toggleFavorite(item, favoriteBtn);
    });
    actions.appendChild(favoriteBtn);

    card.appendChild(actions);
    resultsContainer.appendChild(card);
  });
};

const renderFavorites = () => {
  const dict = getDict(state.currentLanguage);
  favoritesContainer.innerHTML = '';
  if (!state.favorites.length) {
    const p = document.createElement('p');
    p.className = 'muted';
    p.textContent = dict['favorites.empty'];
    favoritesContainer.appendChild(p);
    return;
  }

  state.favorites.forEach((fav) => {
    const card = document.createElement('div');
    card.className = 'result-card';

    const tag = createTag(fav.category || 'personalizado', dict);
    card.appendChild(tag);

    const text = document.createElement('p');
    text.textContent = fav.text;
    card.appendChild(text);

    const wordCount = document.createElement('div');
    wordCount.className = 'result-word-count';
    wordCount.textContent = formatWordCount(fav.text.trim().split(/\s+/).filter(Boolean).length);
    card.appendChild(wordCount);

    const actions = document.createElement('div');
    actions.className = 'result-actions';

    const copyBtn = document.createElement('button');
    copyBtn.className = 'btn copy-btn';
    copyBtn.textContent = dict['buttons.copy'];
    copyBtn.type = 'button';
    copyBtn.addEventListener('click', () => copyText(fav.text, copyBtn));

    const favoriteBtn = document.createElement('button');
    favoriteBtn.className = 'btn favorite-btn';
    favoriteBtn.classList.add('active');
    favoriteBtn.textContent = dict['buttons.favorited'];
    favoriteBtn.type = 'button';
    favoriteBtn.addEventListener('click', () => toggleFavorite(fav, favoriteBtn));

    actions.appendChild(copyBtn);
    actions.appendChild(favoriteBtn);
    card.appendChild(actions);
    favoritesContainer.appendChild(card);
  });
};

const toggleFavorite = (item, btn) => {
  const existingIndex = state.favorites.findIndex((fav) => fav.text === item.text);
  const dict = getDict(state.currentLanguage);

  if (existingIndex >= 0) {
    state.favorites.splice(existingIndex, 1);
  } else {
    state.favorites.unshift({
      id: Date.now().toString(),
      text: item.text,
      category: item.category || 'personalizado',
      language: state.currentLanguage,
      tone: toneSelect.value,
      intensity: Number(intensityRange.value),
      createdAt: new Date().toISOString()
    });
  }

  saveFavorites();
  renderFavorites();

  if (btn) {
    const isFav = existingIndex === -1;
    btn.classList.toggle('active', isFav);
    btn.textContent = isFav ? dict['buttons.favorited'] : dict['buttons.saveFavorite'];
  }
};

const fallbackBase = [
  {
    category: 'trabajo',
    text: 'Hola, te escribo para alinear prioridades y evitar confusiones. ¿Podemos revisar juntos los pendientes y acordar el orden?'
  },
  {
    category: 'pareja',
    text: 'Siento lo de ayer. Me gustaría hablarlo con calma y escuchar cómo te sentiste. ¿Te parece si lo vemos esta noche?'
  },
  {
    category: 'familia_amigos',
    text: 'Quería comentarte algo sin presiones: necesito un poco de espacio esta semana para organizarme, pero sigo aquí para ti.'
  },
  {
    category: 'dinero',
    text: 'Hola, te recuerdo el dinero que te presté hace unas semanas. ¿Podrías decirme cuándo te viene bien devolverlo? Lo agradecería mucho.'
  },
  {
    category: 'jefe',
    text: 'Hola, ¿podemos revisar las prioridades de esta semana? Quiero asegurarme de enfocarme en lo que más impacto tiene y cumplir los plazos.'
  },
  {
    category: 'cliente',
    text: 'Hola, lamento el inconveniente con tu solicitud. Ya lo estamos revisando y te compartiré la solución antes de que termine el día. Gracias por la paciencia.'
  },
  {
    category: 'estudio',
    text: 'Profesor/a, tuve un imprevisto y necesitaría entregar el trabajo el [nueva fecha]. Quiero presentarlo bien hecho, ¿sería posible?'
  },
  {
    category: 'trabajo',
    text: 'Gracias por tu ayuda en el proyecto. ¿Podemos agendar 15 minutos mañana para cerrar los pendientes y asignar los siguientes pasos?'
  },
  {
    category: 'pareja',
    text: 'Sé que estás pasando por mucho. No quiero agobiarte; solo recordarte que estoy aquí para apoyarte en lo que necesites.'
  }
];

const fallbackMessages = exampleLanguages.reduce((acc, lang) => {
  acc[lang] = fallbackBase;
  return acc;
}, {});

const buildFallbackMessages = (lang) => {
  const list = fallbackMessages[lang] || fallbackMessages.es;
  return shuffle(list).slice(0, MAX_MESSAGES);
};

const renderExamples = () => {
  const lang = state.currentLanguage;
  const dict = getDict(lang);
  examplesContainer.innerHTML = '';
  const filtered = examples.filter((ex) => ex.language === lang);
  const selection = shuffle(filtered).slice(0, 6);

  selection.forEach((ex) => {
    const card = document.createElement('div');
    card.className = 'example-card';

    const tag = createTag(ex.category, dict);
    card.appendChild(tag);

    const title = document.createElement('h4');
    title.textContent = ex.title;
    card.appendChild(title);

    const meta = document.createElement('p');
    meta.className = 'example-meta';
    meta.textContent = ex.details;
    card.appendChild(meta);

    const btn = document.createElement('button');
    btn.className = 'btn example-btn';
    btn.textContent = dict['buttons.useExample'];
    btn.type = 'button';
    btn.addEventListener('click', () => applyExample(ex));
    card.appendChild(btn);

    examplesContainer.appendChild(card);
  });
};

const applyExample = (example) => {
  situationInput.value = example.quick;
  situationTextarea.value = example.details;
  toneSelect.value = example.tone;
  intensityRange.value = example.intensity;
  updateIntensityLabel();
  updateWordCount();
  if (example.language && example.language !== state.currentLanguage) {
    applyLanguage(example.language);
  }
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
};

const saveHistoryEntry = (payload, messages) => {
  const entry = {
    id: Date.now().toString(),
    createdAt: new Date().toISOString(),
    title: payload.quick || situationInput.value,
    description: situationTextarea.value,
    tone: payload.tone,
    intensity: payload.intensity,
    language: payload.language,
    firmness: payload.firmness,
    humanize: payload.humanize,
    targetWords: payload.targetWords,
    messages
  };
  state.history.push(entry);
  saveHistory();
};

const setLoadingState = (isLoading) => {
  generateBtn.disabled = isLoading;
  const dict = getDict(state.currentLanguage);
  if (isLoading) {
    resultsContainer.innerHTML = `<p class="status loading">${dict['status.loading']}</p>`;
  }
};

const generateMessages = async () => {
  const title = situationInput.value.trim();
  const description = situationTextarea.value.trim();
  if (!title || !description) {
    renderMessages([]);
    return;
  }

  const language = state.currentLanguage;
  const tone = toneSelect.value;
  const intensity = Number(intensityRange.value);
  const humanize = Boolean(humanizeToggle && humanizeToggle.checked);
  state.humanize = humanize;
  const firmness = mapFirmnessFromSlider(intensity);
  const targetWords = getTargetWordsValue();
  const situation = `${title} - ${description}`;
  const payload = {
    situation,
    tone,
    intensity,
    language,
    channel: 'generic',
    quick: title,
    humanize,
    firmness,
    targetWords
  };

  setLoadingState(true);

  try {
    const response = await fetch('/api/generate-message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await response.json();
    if (data?.messages && Array.isArray(data.messages) && data.messages.length) {
      const mapped = normalizeMessages(data.messages)
        .slice(0, MAX_MESSAGES)
        .map((m) => ({
          text: m.text,
          category: m.category || 'personalizado'
        }));
      renderMessages(mapped, true);
      saveHistoryEntry(payload, mapped);
    } else {
      const fallback = buildFallbackMessages(language);
      renderMessages(fallback, true);
    }
  } catch (error) {
    console.error('Generation failed', error);
    const fallback = buildFallbackMessages(state.currentLanguage);
    renderMessages(fallback, true);
  } finally {
    setLoadingState(false);
  }
};

const hasCookieConsent = () => {
  try {
    return localStorage.getItem(COOKIE_CONSENT_KEY) === 'true';
  } catch (e) {
    return false;
  }
};

const setCookieConsent = () => {
  try {
    localStorage.setItem(COOKIE_CONSENT_KEY, 'true');
  } catch (e) {
    // ignore
  }
};

const showCookieBanner = () => {
  if (!cookieBanner) return;
  cookieBanner.classList.add('visible');
  cookieBanner.removeAttribute('aria-hidden');
};

const hideCookieBanner = () => {
  if (!cookieBanner) return;
  cookieBanner.classList.remove('visible');
  cookieBanner.setAttribute('aria-hidden', 'true');
};

const initCookieBanner = () => {
  if (!cookieBanner || !cookieAcceptBtn) return;
  if (hasCookieConsent()) {
    hideCookieBanner();
  } else {
    showCookieBanner();
  }

  cookieAcceptBtn.addEventListener('click', () => {
    setCookieConsent();
    hideCookieBanner();
  });
};

document.addEventListener('DOMContentLoaded', () => {
  loadFavorites();
  loadHistory();
  applyLanguage(state.currentLanguage);

  languageSelect.addEventListener('change', (e) => applyLanguage(e.target.value));
  intensityRange.addEventListener('input', updateIntensityLabel);
  situationTextarea.addEventListener('input', updateWordCount);
  updateWordCount();
  initializeTargetWordsInput();
  if (humanizeToggle) {
    humanizeToggle.addEventListener('change', () => {
      state.humanize = humanizeToggle.checked;
    });
  }
  generateBtn.addEventListener('click', generateMessages);
  initCookieBanner();
});
